generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ExternalSystem {
  IMWEB
  ECOUNT
}

enum SyncDirection {
  PULL
  PUSH
}

enum SOTMode {
  LEGACY_IMWEB
  MASTER
}

enum SourceOfTruth {
  IMWEB
  MASTER
}

model Product {
  id                  String   @id @default(uuid())
  master_code         String   @unique
  name                String
  barcode             String   @unique
  release_date        DateTime
  label               String
  issued_category_id  String
  current_category_id String
  category_ids_raw    Json
  price_krw           Int
  inventory_track     Boolean
  stock_qty           Int?
  sale_status         String?
  display_status      Boolean
  description_html    String?  @db.Text
  option_name         String?
  sot_mode            SOTMode  @default(LEGACY_IMWEB)
  shipping_profile_id String?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  shippingProfile   ShippingProfile?     @relation(fields: [shipping_profile_id], references: [id])
  externalRefs      ExternalRef[]
  channelVisibility ChannelVisibility[]
  optionValues      ProductOptionValue[]
  images            ProductImage[]
  codeHistory       ProductCodeHistory[]

  @@index([issued_category_id])
  @@index([current_category_id])
  @@index([shipping_profile_id])
}

model CodeSequenceByCategory {
  issued_category_id String @id
  next_seq           Int    @default(1)
}

model ExternalRef {
  id                  String         @id @default(uuid())
  product_id          String
  system              ExternalSystem
  external_product_id String
  external_url        String?        @db.Text
  source_of_truth     SourceOfTruth?
  last_sync_direction SyncDirection?
  last_synced_at      DateTime?
  raw_snapshot_json   Json?
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([system, external_product_id])
  @@index([product_id])
}

enum SalesChannel {
  KODY_GLOBAL
  KPOP_WHOLESALE
  KPOP_B2B
}

model ChannelVisibility {
  id         Int          @id @default(autoincrement())
  product_id String
  channel    SalesChannel
  is_visible Boolean      @default(true)
  created_at DateTime     @default(now())
  updated_at DateTime     @updatedAt

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([product_id, channel])
  @@index([channel])
}

model ShippingProfile {
  id             String   @id @default(uuid())
  name           String
  base_country   String
  method         String
  template_code  String?
  bundle_allowed Boolean  @default(false)
  is_default     Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  products Product[]
}

model ExchangeRate {
  id              String   @id @default(uuid())
  base_currency   String
  target_currency String
  rate            Decimal  @db.Decimal(18, 6)
  effective_from  DateTime
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
}

model ProductImage {
  id          Int    @id @default(autoincrement())
  product_id  String
  type        String
  storage_key String @db.Text
  sort_order  Int    @default(0)

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id])
}

model ProductOptionValue {
  id              Int    @id @default(autoincrement())
  product_id      String
  option_name     String
  display_value   String
  canonical_value String

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([product_id, option_name, canonical_value])
  @@index([product_id])
}

model ProductCodeHistory {
  id              Int      @id @default(autoincrement())
  product_id      String
  old_master_code String
  new_master_code String
  changed_at      DateTime @default(now())
  reason          String?

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id])
}
